<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS System - UML Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: white;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            border-bottom: 3px solid #2d4891;
        }

        .header h1 {
            color: #2d4891;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .diagram-section {
            margin-bottom: 60px;
            page-break-inside: avoid;
        }

        .diagram-header {
            color: #2d4891;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-left: 5px solid #2d4891;
        }

        .diagram-description {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #2d4891;
        }

        .diagram-description h3 {
            color: #2d4891;
            margin-bottom: 10px;
        }

        .diagram-description ul {
            margin-left: 20px;
        }

        .diagram-description li {
            margin-bottom: 5px;
            color: #555;
        }

        .diagram-content {
            padding: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
        }

        .mermaid {
            text-align: center;
        }

        .export-buttons {
            text-align: center;
            margin: 40px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .export-btn {
            background: #2d4891;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0 10px;
        }

        .export-btn:hover {
            background: #1e3a8a;
        }

        .export-btn.secondary {
            background: #059669;
        }

        .export-btn.secondary:hover {
            background: #047857;
        }

        @media print {
            .export-buttons {
                display: none;
            }
            
            body {
                padding: 0;
            }
            
            .diagram-section {
                margin-bottom: 40px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .diagram-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è EMS System UML Diagrams</h1>
            <p>Environmental Management System - Complete UML Documentation</p>
        </div>

        <div class="export-buttons">
            <button class="export-btn" onclick="window.print()">üñ®Ô∏è Print/Export to PDF</button>
            <button class="export-btn secondary" onclick="reloadDiagrams()">üîÑ Reload Diagrams</button>
        </div>

        <!-- Class Diagram -->
        <div class="diagram-section">
            <div class="diagram-header">üìä Class Diagram - System Architecture & Data Models</div>
            <div class="diagram-description">
                <h3>Class Diagram Overview:</h3>
                <ul>
                    <li><strong>User Management:</strong> Admin, Executive, and Visitor user classes with role-based access</li>
                    <li><strong>Data Models:</strong> Enquiry, ChatMessage, Article, FAQ, and Visitor entities</li>
                    <li><strong>Relationships:</strong> Associations, inheritance, and dependencies between classes</li>
                    <li><strong>Attributes & Methods:</strong> Key properties and behaviors of each class</li>
                </ul>
            </div>
            <div class="diagram-content">
                <div class="mermaid" id="classDiagram">
                    classDiagram
                        class User {
                            +String _id
                            +String username
                            +String email
                            +String password
                            +String role
                            +String name
                            +Date createdAt
                            +Date updatedAt
                            +login(credentials)
                            +logout()
                            +updateProfile(data)
                            +checkPermissions()
                        }

                        class Admin {
                            +String adminId
                            +String permissions
                            +manageUsers()
                            +viewAnalytics()
                            +systemSettings()
                            +generateReports()
                        }

                        class Executive {
                            +String execId
                            +String department
                            +viewPersonalMetrics()
                            +manageChats()
                            +handleEnquiries()
                        }

                        class Visitor {
                            +String visitorId
                            +String name
                            +String email
                            +String phone
                            +Date visitDate
                            +register()
                            +accessChatbot()
                            +searchFAQ()
                        }

                        class Enquiry {
                            +String _id
                            +String visitorId
                            +String subject
                            +String message
                            +String status
                            +Date createdAt
                            +String assignedTo
                            +create()
                            +update()
                            +assignTo(user)
                            +close()
                        }

                        class ChatMessage {
                            +String _id
                            +String sessionId
                            +String sender
                            +String message
                            +String type
                            +Date timestamp
                            +send()
                            +receive()
                            +store()
                        }

                        class Article {
                            +String _id
                            +String title
                            +String content
                            +String category
                            +String[] tags
                            +String excerpt
                            +Number readTime
                            +Date publishedAt
                            +create()
                            +update()
                            +search()
                            +getByCategory()
                        }

                        class FAQ {
                            +String _id
                            +String question
                            +String answer
                            +String category
                            +String[] tags
                            +Number priority
                            +create()
                            +update()
                            +search()
                            +getByCategory()
                        }

                        class Analytics {
                            +String _id
                            +Number totalVisitors
                            +Number totalEnquiries
                            +Number totalChats
                            +Object dailyStats
                            +Object agentPerformance
                            +generateReport()
                            +getMetrics()
                            +updateStats()
                        }

                        User <|-- Admin
                        User <|-- Executive
                        User <|-- Visitor
                        
                        Visitor ||--o{ Enquiry : creates
                        Visitor ||--o{ ChatMessage : sends
                        Executive ||--o{ Enquiry : handles
                        Executive ||--o{ ChatMessage : responds
                        
                        Admin ||--o{ Article : manages
                        Admin ||--o{ FAQ : manages
                        Admin ||--o{ Analytics : views
                        
                        Visitor ||--o{ Article : reads
                        Visitor ||--o{ FAQ : searches
                </div>
            </div>
        </div>

        <!-- Use Case Diagram -->
        <div class="diagram-section">
            <div class="diagram-header">üéØ Use Case Diagram - System Functionality & User Interactions</div>
            <div class="diagram-description">
                <h3>Use Case Overview:</h3>
                <ul>
                    <li><strong>Authentication:</strong> Login, logout, and session management</li>
                    <li><strong>Dashboard Access:</strong> Role-based dashboard and feature access</li>
                    <li><strong>Chatbot System:</strong> Visitor registration and AI chat interactions</li>
                    <li><strong>Content Management:</strong> FAQ and article management</li>
                    <li><strong>Analytics:</strong> Data visualization and reporting</li>
                </ul>
            </div>
            <div class="diagram-content">
                <div class="mermaid" id="useCaseDiagram">
                    graph TB
                        subgraph Actors
                            A[üë§ Admin User]
                            E[üëî Executive User]
                            V[üë• Public Visitor]
                        end

                        subgraph Authentication
                            UC1[üîê Login]
                            UC2[üö™ Logout]
                            UC3[üîë Session Management]
                        end

                        subgraph Dashboard
                            UC4[üìä View Dashboard]
                            UC5[‚öôÔ∏è Manage Settings]
                            UC6[üë• User Management]
                        end

                        subgraph Chatbot
                            UC7[ü§ñ Access Chatbot]
                            UC8[üìù Register as Visitor]
                            UC9[üí¨ Chat with AI]
                            UC10[‚ùì Search FAQ]
                        end

                        subgraph Content
                            UC11[üì∞ Manage Articles]
                            UC12[‚ùì Manage FAQs]
                            UC13[üìñ Read Articles]
                            UC14[üîç Search Content]
                        end

                        subgraph Analytics
                            UC15[üìà View Analytics]
                            UC16[üìä Generate Reports]
                            UC17[üìã Handle Enquiries]
                        end

                        subgraph Communication
                            UC18[üí¨ Manage Chats]
                            UC19[üìß Send Messages]
                            UC20[üìû Track Visitors]
                        end

                        A --> UC1
                        A --> UC2
                        A --> UC3
                        A --> UC4
                        A --> UC5
                        A --> UC6
                        A --> UC11
                        A --> UC12
                        A --> UC15
                        A --> UC16

                        E --> UC1
                        E --> UC2
                        E --> UC3
                        E --> UC4
                        E --> UC5
                        E --> UC17
                        E --> UC18
                        E --> UC19
                        E --> UC20

                        V --> UC7
                        V --> UC8
                        V --> UC9
                        V --> UC10
                        V --> UC13
                        V --> UC14
                </div>
            </div>
        </div>

        <!-- Sequence Diagram -->
        <div class="diagram-section">
            <div class="diagram-header">‚è±Ô∏è Sequence Diagram - User Authentication & Dashboard Access Flow</div>
            <div class="diagram-description">
                <h3>Sequence Flow Overview:</h3>
                <ul>
                    <li><strong>Authentication Process:</strong> Complete login flow with JWT token generation</li>
                    <li><strong>Role Verification:</strong> User role checking and permission assignment</li>
                    <li><strong>Dashboard Loading:</strong> Role-specific dashboard rendering</li>
                    <li><strong>Data Fetching:</strong> API calls and database interactions</li>
                </ul>
            </div>
            <div class="diagram-content">
                <div class="mermaid" id="sequenceDiagram">
                    sequenceDiagram
                        participant U as User
                        participant F as Frontend
                        participant A as Auth API
                        participant D as Database
                        participant S as System

                        U->>F: Visit Login Page
                        F->>F: Load Login Form
                        U->>F: Enter Credentials
                        F->>A: POST /api/auth/login
                        A->>D: Query User Data
                        D-->>A: Return User Info
                        A->>A: Validate Password
                        A->>A: Generate JWT Token
                        A-->>F: Return Token + User Data
                        F->>F: Store Token in localStorage
                        F->>F: Check User Role
                        
                        alt Admin User
                            F->>F: Redirect to Admin Dashboard
                            F->>S: Load Admin Components
                            F->>A: GET /api/analytics
                            A->>D: Fetch Analytics Data
                            D-->>A: Return Analytics
                            A-->>F: Return Dashboard Data
                            F->>F: Render Admin Dashboard
                        else Executive User
                            F->>F: Redirect to Executive Dashboard
                            F->>S: Load Executive Components
                            F->>A: GET /api/executive/metrics
                            A->>D: Fetch Personal Metrics
                            D-->>A: Return Metrics
                            A-->>F: Return Dashboard Data
                            F->>F: Render Executive Dashboard
                        else Public Visitor
                            F->>F: Redirect to Landing Page
                            F->>S: Load Public Components
                            F->>F: Show Chatbot Widget
                        end

                        F-->>U: Display Appropriate Dashboard
                </div>
            </div>
        </div>

        <!-- Activity Diagram -->
        <div class="diagram-section">
            <div class="diagram-header">üîÑ Activity Diagram - Chatbot System & Enquiry Processing Flow</div>
            <div class="diagram-description">
                <h3>Activity Flow Overview:</h3>
                <ul>
                    <li><strong>Visitor Registration:</strong> Complete visitor onboarding process</li>
                    <li><strong>Chatbot Interaction:</strong> AI-powered conversation flow</li>
                    <li><strong>Enquiry Creation:</strong> Automatic lead generation</li>
                    <li><strong>Content Search:</strong> FAQ and article search functionality</li>
                    <li><strong>Executive Assignment:</strong> Enquiry routing and handling</li>
                </ul>
            </div>
            <div class="diagram-content">
                <div class="mermaid" id="activityDiagram">
                    graph TD
                        Start([Visitor Arrives]) --> A{Has Account?}
                        A -->|No| B[Show Registration Form]
                        A -->|Yes| C[Login Process]
                        
                        B --> D[Collect Visitor Info]
                        D --> E[Validate Data]
                        E -->|Invalid| F[Show Error Message]
                        F --> B
                        E -->|Valid| G[Create Visitor Record]
                        
                        C --> H[Authenticate User]
                        H -->|Success| I[Load User Profile]
                        H -->|Failed| J[Show Login Error]
                        J --> C
                        
                        G --> K[Initialize Chat Session]
                        I --> K
                        
                        K --> L[Display Chatbot Interface]
                        L --> M[Show Welcome Message]
                        M --> N[Present Service Options]
                        
                        N --> O{User Action}
                        O -->|Ask Question| P[Process Query]
                        O -->|Search FAQ| Q[FAQ Search Interface]
                        O -->|Read Articles| R[Article Browser]
                        O -->|Create Enquiry| S[Enquiry Form]
                        
                        P --> T[AI Response Generation]
                        T --> U[Display Response]
                        U --> V{Need Human Help?}
                        V -->|Yes| S
                        V -->|No| W[Continue Chat]
                        W --> O
                        
                        Q --> X[Search FAQ Database]
                        X --> Y[Display Results]
                        Y --> Z[User Selects FAQ]
                        Z --> AA[Show Detailed Answer]
                        AA --> O
                        
                        R --> BB[Browse Articles]
                        BB --> CC[Filter by Category]
                        CC --> DD[Display Articles]
                        DD --> EE[User Reads Article]
                        EE --> O
                        
                        S --> FF[Collect Enquiry Details]
                        FF --> GG[Validate Enquiry Data]
                        GG -->|Invalid| HH[Show Validation Error]
                        HH --> FF
                        GG -->|Valid| II[Create Enquiry Record]
                        
                        II --> JJ[Assign to Executive]
                        JJ --> KK[Send Notification]
                        KK --> LL[Update Dashboard]
                        LL --> MM[Enquiry Processing]
                        
                        MM --> NN{Executive Action}
                        NN -->|Respond| OO[Send Response]
                        NN -->|Close| PP[Mark as Resolved]
                        NN -->|Escalate| QQ[Assign to Admin]
                        
                        OO --> RR[Update Chat History]
                        PP --> SS[Archive Enquiry]
                        QQ --> TT[Admin Review]
                        
                        RR --> O
                        SS --> End([Process Complete])
                        TT --> UU[Admin Decision]
                        UU --> End
                </div>
            </div>
        </div>

        <!-- Component Diagram -->
        <div class="diagram-section">
            <div class="diagram-header">üß© Component Diagram - System Architecture & Component Relationships</div>
            <div class="diagram-description">
                <h3>Component Overview:</h3>
                <ul>
                    <li><strong>Frontend Components:</strong> Next.js pages, React components, and UI modules</li>
                    <li><strong>Backend Services:</strong> Express routes, middleware, and business logic</li>
                    <li><strong>Database Layer:</strong> MongoDB collections and data models</li>
                    <li><strong>External Services:</strong> Authentication, analytics, and third-party integrations</li>
                </ul>
            </div>
            <div class="diagram-content">
                <div class="mermaid" id="componentDiagram">
                    graph TB
                        subgraph "Frontend Layer"
                            UI[User Interface]
                            DASH[Dashboard Components]
                            CHAT[Chatbot Widget]
                            AUTH[Authentication UI]
                            ANALYTICS[Analytics Charts]
                        end

                        subgraph "Backend API"
                            AUTH_API[Authentication API]
                            USER_API[User Management API]
                            CHAT_API[Chat API]
                            ENQUIRY_API[Enquiry API]
                            ANALYTICS_API[Analytics API]
                            CONTENT_API[Content API]
                        end

                        subgraph "Middleware"
                            JWT_MW[JWT Middleware]
                            CORS_MW[CORS Middleware]
                            AUTH_MW[Auth Middleware]
                            LOG_MW[Logging Middleware]
                        end

                        subgraph "Database Layer"
                            USER_DB[(User Collection)]
                            ENQUIRY_DB[(Enquiry Collection)]
                            CHAT_DB[(Chat Collection)]
                            CONTENT_DB[(Content Collection)]
                            ANALYTICS_DB[(Analytics Collection)]
                        end

                        subgraph "External Services"
                            JWT_SERVICE[JWT Service]
                            EMAIL_SERVICE[Email Service]
                            AI_SERVICE[AI Chat Service]
                        end

                        UI --> AUTH_API
                        DASH --> USER_API
                        DASH --> ANALYTICS_API
                        CHAT --> CHAT_API
                        AUTH --> AUTH_API
                        ANALYTICS --> ANALYTICS_API

                        AUTH_API --> JWT_MW
                        USER_API --> AUTH_MW
                        CHAT_API --> AUTH_MW
                        ENQUIRY_API --> AUTH_MW
                        ANALYTICS_API --> AUTH_MW
                        CONTENT_API --> AUTH_MW

                        JWT_MW --> JWT_SERVICE
                        AUTH_MW --> JWT_SERVICE

                        AUTH_API --> USER_DB
                        USER_API --> USER_DB
                        CHAT_API --> CHAT_DB
                        ENQUIRY_API --> ENQUIRY_DB
                        ANALYTICS_API --> ANALYTICS_DB
                        CONTENT_API --> CONTENT_DB

                        CHAT_API --> AI_SERVICE
                        ENQUIRY_API --> EMAIL_SERVICE
                </div>
            </div>
        </div>

        <!-- State Diagram -->
        <div class="diagram-section">
            <div class="diagram-header">üîÑ State Diagram - Enquiry Lifecycle Management</div>
            <div class="diagram-description">
                <h3>State Flow Overview:</h3>
                <ul>
                    <li><strong>Enquiry States:</strong> Complete lifecycle from creation to resolution</li>
                    <li><strong>State Transitions:</strong> Clear progression through different stages</li>
                    <li><strong>Action Triggers:</strong> Events that cause state changes</li>
                    <li><strong>Final States:</strong> Resolution and archival processes</li>
                </ul>
            </div>
            <div class="diagram-content">
                <div class="mermaid" id="stateDiagram">
                    stateDiagram-v2
                        [*] --> Created
                        Created --> UnderReview : Assign to Executive
                        UnderReview --> InProgress : Executive Starts Work
                        UnderReview --> Escalated : Requires Admin Attention
                        InProgress --> WaitingForResponse : Send Response
                        WaitingForResponse --> InProgress : Receive Follow-up
                        WaitingForResponse --> Resolved : Visitor Satisfied
                        InProgress --> Resolved : Complete Resolution
                        Escalated --> UnderReview : Admin Reassigns
                        Resolved --> Archived : Close Enquiry
                        Archived --> [*]
                </div>
            </div>
        </div>

        <div class="export-buttons">
            <button class="export-btn" onclick="window.print()">üñ®Ô∏è Print/Export to PDF</button>
            <button class="export-btn secondary" onclick="reloadDiagrams()">üîÑ Reload Diagrams</button>
        </div>
    </div>

    <script>
        // Initialize Mermaid with optimal settings for UML diagrams
        mermaid.initialize({
            startOnLoad: false, // We'll manually trigger rendering
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                nodeSpacing: 50,
                rankSpacing: 50
            },
            sequence: {
                useMaxWidth: true,
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                bottomMarginAdj: 1,
                useMaxWidth: true,
                rightAngles: false,
                showSequenceNumbers: false
            },
            class: {
                useMaxWidth: true,
                nodeSpacing: 50,
                rankSpacing: 50
            },
            state: {
                useMaxWidth: true,
                nodeSpacing: 50,
                rankSpacing: 50
            }
        });

        // Function to render all diagrams
        function renderDiagrams() {
            console.log('Rendering UML diagrams...');
            
            // Render each diagram individually
            const diagrams = [
                'classDiagram',
                'useCaseDiagram', 
                'sequenceDiagram',
                'activityDiagram',
                'componentDiagram',
                'stateDiagram'
            ];

            diagrams.forEach((id, index) => {
                setTimeout(() => {
                    try {
                        const element = document.getElementById(id);
                        if (element) {
                            console.log(`Rendering ${id}...`);
                            mermaid.render(`mermaid-${id}`, element.textContent).then(({svg}) => {
                                element.innerHTML = svg;
                            }).catch(err => {
                                console.error(`Error rendering ${id}:`, err);
                                element.innerHTML = `<p style="color: red;">Error rendering diagram: ${err.message}</p>`;
                            });
                        }
                    } catch (err) {
                        console.error(`Error with ${id}:`, err);
                    }
                }, index * 500); // Stagger rendering to avoid conflicts
            });
        }

        // Function to reload diagrams
        function reloadDiagrams() {
            console.log('Reloading diagrams...');
            // Clear existing diagrams
            const mermaidElements = document.querySelectorAll('.mermaid');
            mermaidElements.forEach(element => {
                element.innerHTML = element.getAttribute('data-original') || element.textContent;
            });
            
            // Re-render after a short delay
            setTimeout(renderDiagrams, 100);
        }

        // Store original content for reload
        document.addEventListener('DOMContentLoaded', function() {
            const mermaidElements = document.querySelectorAll('.mermaid');
            mermaidElements.forEach(element => {
                element.setAttribute('data-original', element.textContent);
            });
            
            // Start rendering after page loads
            setTimeout(renderDiagrams, 500);
        });

        // Handle print/export
        window.addEventListener('beforeprint', function() {
            // Ensure all diagrams are rendered before printing
            setTimeout(renderDiagrams, 100);
        });
    </script>
</body>
</html>
